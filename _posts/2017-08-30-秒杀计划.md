---
layout: post
title: 发布优化——秒杀计划
date: 2017-08-30
categories: 性能优化
tags: [性能, PHP]
---
###背景
用户在百姓网点击发布按钮后，除了常规的表单字段校验和入库，百姓后端的风险控制系统需要对用户输入的信息进行一系列的风险和信息质量分析，完成风险和质量分析之后才会向用户返回信息的发布状态。比较繁重的信息分析过程拉长了用户发布的响应时间，为了优化用户的发布体验，技术部门于上个月底启动了发布优化项目——“秒杀计划”。

项目启动之后，作为百姓风险控制部门的主要技术之一，荣幸而又紧张地成为了这个项目的实施者。以下便是实施这个项目的心路历程，总结下来和各位同学分享。
###现状和目标
#####现状
95%发布&更新操作的平均耗时为3秒左右。
#####目标
95%发布&更新操作的三平台平均耗时降到1秒以内。
> 95%分位：一个样本集中95%的样本值都小于某一个值，取该值为该样本集的95%分位

###定位问题点
整个风险控制系统像一个内部结构复杂且运载历史很长的发动机，如果你的项目时间足够充裕，可以把它的一个一个零件都研究一遍，然后一个一个换成最新款的高配版零件。但事实情况往往都是项目时间很有限，我们要在很有限的时间做出效果就需要去定位“提升空间最大”和“最容易提升”的模块或者零件。

定位问题需要获取可靠的可供分析问题的资料，本次分析主要从如下两个方面入手：
####火焰图工具
火焰图工具可以让我们直观地看到一个操作从开始到结束的程序调用栈以及每个调用栈所消耗的时间，篇幅有限，如何生成火焰图在此次不做扩展，感兴趣的同学可以自行 Goole。

下图截取自项目第一天进行的线上发布火焰图样例，不同的类目不同的用户不同的时间段都会造成火焰图的变动，下图是综合评估后较为接近平均水平的一张。

![Alt text](../images/fabu/fabu_profiling_origin.png)

>注：火焰图的y轴表示方法调用的先后，x轴表示在每个采样调用时间内，方法所占的时间百分比，越宽代表占据时间越多

从火焰图可以直观地看到要优化的调用栈占总发布时间的占比，也能比较明确地定位出该调用栈比较耗时的子模块：

1. 云计算模块
2. 关键词模块

找到了耗时最长模块之后，又对相应的模块进行了火焰图分析。从模块的火焰图分析中可以知道云计算模块中耗时最长的为数据加载，关键词模块中耗时最长的为关键词匹配算法。

####历史的打点数据
定位了可优先优化的目标子模块，这个时候我们想知道更多的详细数据，比如目标子模块关键算法的耗时精确数据，目标子模块的慢查询 log，这个时候历史的日志数据就非常有用了。

云计算模块和关键词的慢查询日志以及关键算法的耗时打点暴露出了数据结构和算法设计的可提升之处。分析进展到这一步，发布优化这个大问题的层层迷雾已经被渐渐拨开，在心中确认优化的方向之后，就着手准备正式进入技术设计和实现。

###拟定优化计划
火焰图和历史日志的分析为我们提供了几个极有优化价值的点，但并不是我们唯一可做的点。要在很有限的项目周期中做出比较可观的效果，我们得给自己可做的优化列一个执行的优先级，原则比较简单，按性价比从高到低排序。于是有了如下的初步实施计划：
 
 1. 任务异步可以有效加快响应时间，找出发布服务中可以异步的风险控制子服务，如信息质量分计算服务。将此类服务扔到队列中异步执行可以有效地给发布服务耗时做减法，经评估开发工时小于0.5工作日／1人，性价比最优，最先执行。
 2. 推进业务端对风控系统中规则引擎模块的使用优化。
 3. 优化提升潜力最大，优化难度也最高的云计算模块。
 4. 优化关键词模块。

###布置验收环境
在正式开始开发之前必须要确定自己成果验收方案，建立实时的模块耗时数据打点对于此次验收是非常直观的方式。因此在开发之前首先完善了发布各平台的发布耗时打点，发布服务各模块的耗时打点，以及风险控制系统关键模块和关键算法的耗时打点。

###进入开发，逐点提升
####“上小菜提神”——提炼可异步的任务
花了一个小时整理了发布服务中可以异步的风险控制子服务，花了约三小时将这些服务异步化测试上线，整个过程异常轻松。但是这碗小菜却像是从便利店买了一包速冻食品，获取得轻松愉快，却也真的没什么口感和营养——上线后发布服务的耗时曲线丝毫不为所动。看了异步化的两个服务的99%平均耗时之和是40毫秒不到之后，也充分理解了这个结果——优化的点太小。
 
####“喝口汤润胃”——推进业务端的使用优化
性能优化并不仅仅是技术的优化，有时候从业务的角度去考虑也能有一些惊喜。风险控制系统中有个重要的规则引擎模块，这个模块允许业务人员自定义规则对用户发布的信息进行风险评估。久而久之系统中积攒了大量的规则，而这些规则中也包含一些已失效却仍在空跑的规则，也包含一些可以从信息发布前移到信息发布后执行的规则。此条举措便是优化业务端对规则引擎模块的使用，降低规则引擎模块对发布服务性能的负影响。

此项优化获得了300毫秒左右的发布性能提升。

####“上盘肉来劲”——优化云计算
虽然前期已经做了充分的分析，但是到真正进入云计算的优化的时候心里还是十分忐忑的，忐忑的缘由许多同学都会似曾相识——属于底层服务且代码太难读懂，不敢改，生怕一个不小心百姓主站就挂在自己手上。

云计算优化的一整天都在看源码，当年写云计算模块的前辈的代码质量确实足以用来考验后辈，太多难以理解的变量函数命名以及复杂的逻辑跳转。大概在看了12个小时的源码之后，终于对云计算整体的逻辑有了一定的把握。下图为当时所测的云计算的火焰图：

![Alt text](../images/fabu/cloud_profiling.jpeg)

在掌握了云计算模块的整体逻辑之后，开始定点研究云计算的 Data::load 为何耗时很长。于是便有了接下来的进展：

##### 加载了一大堆多余数据
为了优化搜索性能，在搜索的时候并未去数据池中将完整的数据取出，而是返回搜索对象`SearchResult`，该对象实现了`PHP`的聚合式迭代器接口`IteratorAggregate `（http://php.net/manual/zh/class.iteratoraggregate.php），使得用户在遍历搜索对象的时候才会真正地去数据池中拿出完整的数据。

例（仅作示例辅助理解，并非正式源码）：

``` 
class SearchResult implements IteratorAggregate {
	public function __construct($ids = []) {
		$this->ids = $ids;
	}
	
	public function getIds() {
		return $this->ids;
	}
	
	public function getIterator() {
		return new ArrayIterator(Node::fetch($this->ids, true));
	}

}
```
这个设计已经十分友好了，然而云计算对搜索结果的使用却不太友好。一次云计算的过程要去信息池中加载多次数据，加载次数取决于用户所发的所有帖子的云参数的多样性，加载数据量以及加载的次数和用户的发帖量成正比。云计算模块的设计缺陷导致在进行多次搜索结果的合并时，是通过遍历搜索结果合并而不是调用`getIds()`方法合并搜索结果集的`id`，而最后真正用于云计算的信息量却是加载出来的一部分。大用户越多，这种浪费越严重，因为你加载了3万的帖子，最后可能只有1000个帖子被真正用于计算（注：被用于计算的帖子量根据不同的业务情景有不同的上限值，此处1000仅用作举例无实际参考意义）。

找出了原因之后，写代码已经是体力活了。修正了云计算模块的搜索结果合并逻辑后，整个发布服务以及风险控制服务都立即有了一个令人欣喜的骤降趋势——提升了600毫秒左右。

##### 将云计算的搜索升级成并发，会变快的吧？
云计算模块和搜索模块的交互是通过`HTTP`请求，上面说到一次云计算要请求多次搜索模块，且请求次数和用户的发帖量成正比。如果我能实现并发请求搜索模块，就意味着我可以将原来串行的20个请求一次并行发送出去。在线下的模拟测试结果确实充分证实并行搜索比串行搜索快出很多，所以这个想法变得越来越引人入胜，虽然这项改动涉及到对云计算模块比较大的重构，但我当时深信这个开发成本肯定会有很可观的速度提升。

于是开始了这个项目耗时最长的一项优化，深度重构云计算模块。在重构了5个工作日+一整个周末后，我的代码终于通过了Mentor的审核以及反复的线下测试，就在终于松口气准备跑一下`Unit Test`就上线的时候悲剧地发现`Unit Test`没通过，更悲剧的是当我`Debug`到相应的报错函数时——那个函数有800多行，而且报错信息看不出在哪行抛出的，晴天霹雳。我至今仍无法理解，神一般的前辈自己在写那个函数的时候是怎么调试的。

新的云计算上线和旧的云计算进行对半分流`A|B`测试，测试的结果让人欣喜，新的云计算的速度提升了一倍。如下图：

![Alt text](../images/fabu/ab_test.jpeg)

看起来似乎是渐入佳境了，但如写作文的套路，用了‘似乎’的语境后面总有转折。是的，你们肯定猜到了，我全量上线新的云计算之后风险控制服务的整体耗时并没有下降，完全感觉不到降。

这完全意料之外的结果让我对原因产生了极大的好奇，我反复检查了自己`A|B`测试的数据是否有误，结果是`A|B`测试并没有错误。那么是哪？在飞爷的提点下去分析算法中耗时和调用次数正相关的的部分，果然发现在全量上线新的云计算之后，搜索模块的响应时间有一个很明显的增幅，这个增幅削平了新的云计算的算法优化。这个情况为何出现，得深究一下云计算对应的搜索模块的代码，考虑项目周期原因，并未去深究。

####“小碟甜点收心”——优化关键词匹配

###优化成果
### 总结


> {{ page.date | date_to_string }}，原创文章，转载请注明出处