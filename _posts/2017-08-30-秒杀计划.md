---
layout: post
title: 发布优化——秒杀计划
date: 2017-08-30
categories: 性能优化
tags: [性能, PHP]
---
###背景
用户在百姓网点击发布按钮后，除了常规的表单字段校验和入库，百姓后端的风险控制系统需要对用户输入的信息进行一系列的风险和信息质量分析，完成风险和质量分析之后才会向用户返回信息的发布状态。比较繁重的信息分析过程拉长了用户发布的响应时间，为了优化用户的发布体验，技术部门于上个月底启动了发布优化项目——“秒杀计划”。

项目启动之后，作为百姓风险控制部门的主要技术之一，荣幸而又紧张地成为了这个项目的实施者。以下便是实施这个项目的心路历程，总结下来和各位同学分享。
###现状和目标
#####现状
95%发布&更新操作的平均耗时为3秒左右。
#####目标
95%发布&更新操作的三平台平均耗时降到1秒以内。
> 95%分位：一个样本集中95%的样本值都小于某一个值，取该值为该样本集的95%分位

###定位问题点
整个风险控制系统像一个内部结构复杂且运载历史很长的发动机，如果你的项目时间足够充裕，可以把它的一个一个零件都研究一遍，然后一个一个换成最新款的高配版零件。但事实情况往往都是项目时间很有限，我们要在很有限的时间做出效果就需要去定位“提升空间最大”和“最容易提升”的模块或者零件。

定位问题需要获取可靠的可供分析问题的资料，本次分析主要从如下两个方面入手：
####火焰图工具
火焰图工具可以让我们直观地看到一个操作从开始到结束的程序调用栈以及每个调用栈所消耗的时间，篇幅有限，如何生成火焰图在此次不做扩展，感兴趣的同学可以自行 Goole。

下图截取自项目第一天进行的线上发布火焰图样例，不同的类目不同的用户不同的时间段都会造成火焰图的变动，下图是综合评估后较为接近平均水平的一张。

![Alt text](../images/fabu/fabu_profiling_origin.png)

>注：火焰图的y轴表示方法调用的先后，x轴表示在每个采样调用时间内，方法所占的时间百分比，越宽代表占据时间越多

从火焰图可以直观地看到要优化的调用栈占总发布时间的占比，也能比较明确地定位出该调用栈比较耗时的子模块：

1. 云计算模块
2. 关键词模块

找到了耗时最长模块之后，又对相应的模块进行了火焰图分析。从模块的火焰图分析中可以知道云计算模块中耗时最长的为数据加载，关键词模块中耗时最长的为关键词匹配算法。

####历史的打点数据
定位了可优先优化的目标子模块，这个时候我们想知道更多的详细数据，比如目标子模块关键算法的耗时精确数据，目标子模块的慢查询 log，这个时候历史的日志数据就非常有用了。

云计算模块和关键词的慢查询日志以及关键算法的耗时打点暴露出了数据结构和算法设计的可提升之处。分析进展到这一步，发布优化这个大问题的层层迷雾已经被渐渐拨开，在心中确认优化的方向之后，就着手准备正式进入技术设计和实现。

###拟定优化计划
火焰图和历史日志的分析为我们提供了几个极有优化价值的点，但并不是我们唯一可做的点。要在很有限的项目周期中做出比较可观的效果，我们得给自己可做的优化列一个执行的优先级，原则比较简单，按性价比从高到低排序。于是有了如下的初步实施计划：
 
 1. 任务异步可以有效加快响应时间，找出发布服务中可以异步的风险控制子服务，如信息质量分计算服务。将此类服务扔到队列中异步执行可以有效地给发布服务耗时做减法，经评估开发工时小于0.5工作日／1人，性价比最优，最先执行。
 2. 推进业务端对风控系统中规则引擎模块的使用优化。
 3. 优化提升潜力最大，优化难度也最高的云计算模块。
 4. 优化关键词模块。

###布置验收环境
在正式开始开发之前必须要确定自己成果验收方案，建立实时的模块耗时数据打点对于此次验收是非常直观的方式。因此在开发之前首先完善了发布各平台的发布耗时打点，发布服务各模块的耗时打点，以及风险控制系统关键模块和关键算法的耗时打点。

###进入开发，逐点提升
####“上小菜提神”——提炼可异步的任务
花了一个小时整理了发布服务中可以异步的风险控制子服务，花了约三小时将这些服务异步化测试上线，整个过程异常轻松。但是这碗小菜却像是从便利店买了一包速冻食品，获取得轻松愉快，却也真的没什么口感和营养——上线后发布服务的耗时曲线丝毫不为所动。看了异步化的两个服务的99%平均耗时之和是40毫秒不到之后，也充分理解了这个结果——优化的点太小。
 
####“喝口汤润胃”——推进业务端的使用优化
性能优化并不仅仅是技术的优化，有时候从业务的角度去考虑也能有一些惊喜。风险控制系统中有个重要的规则引擎模块，这个模块允许业务人员自定义规则对用户发布的信息进行风险评估。久而久之系统中积攒了大量的规则，而这些规则中也包含一些已失效却仍在空跑的规则，也包含一些可以从信息发布前移到信息发布后执行的规则。此条举措便是优化业务端对规则引擎模块的使用，降低规则引擎模块对发布服务性能的负影响。

此项优化获得了300毫秒左右的发布性能提升。

####“上盘肉来劲”——优化云计算
虽然前期已经做了充分的分析，但是到真正进入云计算的优化的时候心里还是十分忐忑的，忐忑的缘由许多同学都会似曾相识——属于底层服务且代码太难读懂，不敢改，生怕一个不小心百姓主站就挂在自己手上。
####“小碟甜点收心”——优化关键词匹配

###优化成果
### 总结


> {{ page.date | date_to_string }}，原创文章，转载请注明出处